tosca_definitions_version: alien_dsl_1_3_0
description: TOSCA Apache Mesos & Mesosphere Marathon profile
template_name: mesos-types
template_version: 1.2.0
template_author: FastConnect

imports:
  - "tosca-normative-types:1.0.0-ALIEN12"
  - "docker-engine:1.0.0"

node_types:
  alien.nodes.MesosMaster:
    derived_from: tosca.nodes.SoftwareComponent
    description: >
      A Mesos master agent.
    tags:
      icon: /images/mesos_icon.png
    properties:
      # TODO: implement firewall rules, hooks & modules
      firewall_rules:
        type: string
        required: false
      hooks:
        type: string
        required: false
        description: >
          A comma-separated list of hook modules to be installed inside master/slave.
      modules:
        type: string
        required: false
        description: >
          List of modules in a JSON-format to be loaded and be available to the internal subsystems.
      work_dir:
        type: string
        default: /var/lib/mesos
      log_dir:
        type: string
        default: "/var/log/mesos"
        required: false
      port:
        type: integer
        default: 5050
      cluster_name:
        type: string
        default: "Mesos cluster"
        required: false
    artifacts:
      - zoo_config:
          file: artifacts/zoo.cfg
          type: tosca.artifacts.File
    attributes:
      external_url: { concat: ["http://", get_attribute: [HOST, public_ip_address], ":", get_property: [SELF, port]] }
      master_url: { concat: ["zk://", get_operation_output: [SELF, Standard, configure, zk_endpoints], "/mesos"] }
      zk_endpoints: { get_operation_output: [SELF, Standard, configure, zk_endpoints] }
    capabilities:
      master: alien.capabilities.MesosMaster
      host: alien.capabilities.MesosMasterHost
    requirements:
      - host:
          capability: tosca.capabilities.Container
          node: tosca.nodes.Compute
          relationship: tosca.relationships.HostedOn
          occurrences: [1, 1]
          node_filter:
            capabilities:
              - tosca.capabilities.OperatingSystem:
                  properties:
                    - type: { equal: linux }
                    - architecture: { equal: x86_64 }
                    - distribution: { valid_values: [ debian, rhel, ubuntu, centos ] }
    interfaces:
      Standard:
        create:
          inputs:
            OS_DISTR: { get_property: [HOST, os, distribution] }
            OS_VERS: { get_property: [HOST, os, version] }
            IP: { get_attribute: [HOST, ip_address] }
            MESOS_VERSION: { get_property: [SELF, component_version] }
          implementation: scripts/install_mesos.sh
        configure:
          inputs:
            MESOS_CLUSTER: { get_property: [SELF, cluster_name] }
            MESOS_IP: { get_attribute: [HOST, ip_address] }
            MESOS_PORT: { get_property: [SELF, port] }
            MESOS_HOSTNAME: { get_attribute: [HOST, public_ip_address] }
            MESOS_WORK_DIR: { get_property: [SELF, work_dir] }
            MESOS_LOG_DIR: { get_property: [SELF, log_dir] }
          implementation: scripts/master/configure.sh
        start:
          implementation: scripts/master/start.sh
        stop:
          implementation: scripts/master/stop.sh

  alien.nodes.MesosSlave:
    derived_from: tosca.nodes.SoftwareComponent
    description: >
      A Mesos slave agent.
    tags:
      icon: /images/mesos_icon.png
    properties:
      # TODO: implement firewall rules, hooks, modules & attributes
      firewall_rules:
        type: string
        required: false
      hooks:
        type: string
        required: false
        description: >
          A comma-separated list of hook modules to be installed inside master/slave.
      modules:
        type: string
        required: false
        description: >
          List of modules in a JSON-format to be loaded and be available to the internal subsystems.
      log_dir:
        type: string
        default: "/var/log/mesos"
        required: false
      port:
        type: integer
        default: 5051
      attributes:
        type: string
        description: >
          Attributes of the slave machine, in the form: rack:2 or rack:2;u:1
        required: false
      isolation:
        type: string
        required: true
        default: "posix/cpu,posix/mem"
        constraints:
          - valid_values: [ "posix/cpu,posix/mem", "cgroups/cpu,cgroups/mem" ]
      work_dir:
        type: string
        required: false
        default: "/var/lib/mesos"
    interfaces:
      Standard:
        create:
          inputs:
            OS_DISTR: { get_property: [HOST, os, distribution] }
            OS_VERS: { get_property: [HOST, os, version] }
            IP: { get_attribute: [HOST, ip_address] }
            MESOS_VERSION: { get_property: [SELF, component_version] }
          implementation: scripts/install_mesos.sh
        configure:
          inputs:
            MESOS_IP: { get_attribute: [HOST, ip_address] }
            MESOS_PORT: { get_property: [SELF, port] }
            MESOS_HOSTNAME: { get_attribute: [HOST, public_ip_address] }
            MESOS_LOG_DIR: { get_property: [SELF, log_dir] }
            MESOS_WORK_DIR: { get_property: [SELF, work_dir] }
            MESOS_ISOLATION: { get_property: [SELF, isolation] }
          implementation: scripts/slave/configure.sh
        start:
          implementation: scripts/slave/start.sh
        stop:
          implementation: scripts/slave/stop.sh
    capabilities:
      host: alien.capabilities.MesosSlaveHost
    requirements:
      - host:
          capability: tosca.capabilities.Container
          node: tosca.nodes.Compute
          relationship: tosca.relationships.HostedOn
          occurrences: [1, 1]
          node_filter:
            capabilities:
              - tosca.capabilities.OperatingSystem:
                  properties:
                    - type: { equal: linux }
                    - architecture: { equal: x86_64 }
                    - distribution: { valid_values: [ debian, rhel, ubuntu, centos ] }
      - master:
          capability: alien.capabilities.MesosMaster
          relationship: alien.relationships.MesosSlaveConnectsToMaster
          occurrences: [1, 1]
      - docker_cli:
          capability: alien.capabilities.DockerCLI
          relationship: alien.relationships.MesosSlaveDependsOnDocker
          occurrences: [0, 1]
      - dns_server:
          capability: alien.capabilities.MesosDNS
          relationship: alien.relationships.MesosSlaveConnectsToDNS
          occurrences: [0, unbounded]

  alien.nodes.Marathon:
    derived_from: tosca.nodes.SoftwareComponent
    description: >
      Marathon scheduler.
      NB: This component requires Oracle's Java 8. The Oracle licence is therefore implicitly accepted. The licence can be found here: http://www.oracle.com/technetwork/java/javase/downloads/thirdpartylicensereadme-java8-2168078.txt.
    tags:
      icon: images/marathon_icon.png
    attributes:
      external_url: { concat: [ "http://", get_attribute: [HOST, public_ip_address], ":8080/ui"] }
      api_url: { concat: ["http://", get_attribute: [HOST, public_ip_address], ":8080/v2"] }
    capabilities:
      marathon: alien.capabilities.MarathonMaster
      host: alien.capabilities.MarathonHost
    requirements:
      - host:
          capability: alien.capabilities.MesosMasterHost
          relationship: tosca.relationships.HostedOn
          occurrences: [1, 1]
    interfaces:
      Standard:
        create:
          inputs:
            OS: { get_property: [HOST, os, distribution] }
            OS_VERS: { get_property: [HOST, os, version] }
          implementation: scripts/marathon/install.sh
        start:
          inputs:
            MARATHON_MASTER: { get_attribute: [HOST, master_url] }
            MARATHON_HOSTNAME: { get_attribute: [HOST, public_ip_address] }
            MARATHON_ZK: { concat: [ "zk://", get_attribute: [HOST, zk_endpoints], "/marathon" ] }
          implementation: scripts/marathon/start.sh
        stop: scripts/marathon/stop.sh

  alien.nodes.MesosDNS:
    derived_from: tosca.nodes.SoftwareComponent
    description: DNS service for Mesos clusters.
    properties:
      cpu_alloc:
        type: float
        required: true
        default: 1.0
      mem_alloc:
        type: integer
        required: true
        default: 512
    capabilities:
      dns_server: alien.capabilities.MesosDNS
    requirements:
      - host:
          capability: alien.capabilities.MesosSlaveHost
          relationship: tosca.relationships.HostedOn
          occurrences: [1, 1]
      - marathon:
          capability: alien.capabilities.MarathonMaster
          relationship: alien.relationships.MesosDNSConnectsToMaster
          occurrences: [1, 1]
    artifacts:
      - dns_config:
          file: artifacts/mesos-dns-config.json
          type: tosca.artifacts.File
      - marathon_template:
          file: artifacts/mesos-dns-template.json
          type: tosca.artifacts.File
    interfaces:
      Standard:
        create: scripts/service-discovery/install-mesosdns.sh
        configure:
          inputs:
            SLAVE_LOCAL_IP: { get_attribute: [HOST, ip_address] }
            SLAVE_IP: { get_attribute: [HOST, public_ip_address] }
            CPU_ALLOC: { get_property: [SELF, cpu_alloc] }
            MEM_ALLOC: { get_property: [SELF, mem_alloc] }
          implementation: scripts/service-discovery/configure-mesosdns.sh
        start: scripts/service-discovery/start-mesosdns.sh

  alien.nodes.MarathonLB:
    derived_from: tosca.nodes.SoftwareComponent
    description: Marathon load-balancer for Mesos clusters.
    properties:
      instances:
        type: integer
        required: true
        default: 1
      cpu_alloc:
        type: float
        required: true
        default: 1.0
      mem_alloc:
        type: integer
        required: true
        default: 512
    requirements:
      - host:
          capability: alien.capabilities.MarathonHost
          relationship: tosca.relationships.HostedOn
          occurrences: [1, 1]
    artifacts:
      - marathon_template:
          file: artifacts/marathon-lb-template.json
          type: tosca.artifacts.File
    interfaces:
      Standard:
        configure:
          inputs:
            NB_INST: { get_property: [SELF, instances] }
            CPU_ALLOC: { get_property: [SELF, cpu_alloc] }
            MEM_ALLOC: { get_property: [SELF, mem_alloc] }
            MARATHON_API: { get_attribute: [HOST, api_url] }
          implementation: scripts/service-discovery/configure-marathonlb.sh
        start: scripts/service-discovery/start-marathonlb.sh
  alien.nodes.RexrayClient:
    derived_from: tosca.nodes.SoftwareComponent
    description: Docker volume driver plugin for external storage management.
    properties:
      storage_service:
        type: string
        required: true
    requirements:
      - host:
          capability: alien.capabilities.DockerHost
          relationship: tosca.relationships.HostedOn
          occurrences: [1, 1]
      - libstorage_server:
          capability: alien.capabilities.LibStorageServer
          relationship: alien.relationships.RexrayConnectsToLibStorage
    artifacts:
      - rexray_config:
          file: artifacts/rexray_config.yml
          type: tosca.artifacts.File
    interfaces:
      Standard:
        create: scripts/rexray/create.sh
        configure:
          inputs:
            STORAGE_SERVICE: { get_property: [SELF, storage_service] }
          implementation: scripts/rexray/configure_client.sh
        start: scripts/rexray/start.sh
  alien.nodes.RexrayServer:
    derived_from: tosca.nodes.SoftwareComponent
    description: Serves as a centralized libStorage server for Rexray clients
    capabilities:
      - libstorage_server: alien.capabilities.LibStorageServer
    requirements:
      - host:
          capability: tosca.capabilities.Container
          node: tosca.nodes.Compute
          relationship: tosca.relationships.HostedOn
          occurrences: [1, 1]
    artifacts:
      - rexray_config:
          type: tosca.artifacts.File
    interfaces:
      Standard:
        create: scripts/rexray/create.sh
        start: scripts/rexray/start.sh

capability_types:
  alien.capabilities.MesosMasterHost:
    derived_from: tosca.capabilities.Container
  alien.capabilities.MesosMaster:
    derived_from: tosca.capabilities.Root
  alien.capabilities.MesosSlaveHost:
    derived_from: tosca.capabilities.Container
  alien.capabilities.MarathonMaster:
    derived_from: tosca.capabilities.Root
  alien.capabilities.MarathonHost:
    derived_from: tosca.capabilities.Container
  alien.capabilities.MesosDNS:
    derived_from: tosca.capabilities.Root
  alien.capabilities.LibStorageServer:
    derived_from: tosca.capabilities.Endpoint
    properties:
      protocol:
        type: string
        default: tcp
        required: true
      port:
        type: integer
        required: true
        default: 7979

relationship_types:
  alien.relationships.MarathonHostedOnMaster:
    derived_from: tosca.relationships.HostedOn
    description: Relationship used to bind the Marathon scheduler to a Mesos Master
    valid_target_types: [ alien.nodes.MesosMaster ]
  alien.relationships.AppHostedOnSlave:
    derived_from: tosca.relationships.HostedOn
    valid_target_types: [ alien.nodes.MesosSlave ]
  alien.relationships.MesosSlaveConnectsToMaster:
    derived_from: tosca.relationships.ConnectsTo
    description: Relationship used to bind a slave to a master
    valid_target_types: [ alien.nodes.MesosMaster ]
    interfaces:
      Configure:
        post_configure_source:
          inputs:
            MESOS_MASTER: { get_attribute: [TARGET, master_url] }
          implementation: scripts/slave/configure_connectsToMaster.sh
  alien.relationships.MesosDNSConnectsToMaster:
    derived_from: tosca.relationships.ConnectsTo
    valid_target_types: [ alien.nodes.Marathon ]
    interfaces:
      Configure:
        post_configure_source:
          inputs:
            MARATHON_API: { get_attribute: [TARGET, api_url] }
          implementation: scripts/service-discovery/configure_mesosdnsConnectsToMaster.sh
  alien.relationships.AppHostedOnMarathon:
    derived_from: tosca.relationships.HostedOn
    valid_target_types: [ alien.nodes.Marathon ]
  alien.relationships.MesosSlaveConnectsToDNS:
    derived_from: tosca.relationships.ConnectsTo
    valid_target_types: [ alien.nodes.MesosDNS ]
    interfaces:
      Configure:
        add_target:
          inputs:
            DNS_IP: { get_attribute: [TARGET, ip_address] }
          implementation: scripts/slave/configure_connectsToDNS.sh
  alien.relationships.MesosSlaveDependsOnDocker:
    derived_from: tosca.relationships.DependsOn
    valid_target_types: [ alien.nodes.DockerEngine ]
    description: Relationship used to bind a Mesos slave to a Docker engine
    interfaces:
        Configure:
          post_configure_source: scripts/slave/configure_dependsOnDocker.sh
  alien.relationships.RexrayConnectsToLibStorage:
    derived_from: tosca.relationships.ConnectsTo
    valid_target_types: [ alien.nodes.RexrayServer ]
    description: Connects Rexray clients to the Rexray server
    interfaces:
      Configure:
        post_configure_source:
          inputs:
            REXRAY_SERVER: { get_attribute: [TARGET, ip_address ] }
          implementation: scripts/rexray/configure_connectsToLibStorage.sh
